"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],n=!0,o=!1,s=void 0;try{for(var a,i=e[Symbol.iterator]();!(n=(a=i.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,s=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw s}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var express=require("express"),bodyParser=require("body-parser"),axios=require("axios"),path=require("path"),_require=require("html-entities"),decode=_require.decode,multer=require("multer"),mysql=require("mysql2"),session=require("express-session"),cors=require("cors"),bcrypt=require("bcrypt"),app=express(),port=3e3,saltRounds=10,serviceKey="J5hAO%2B3ZBCbL%2F51zkmt9Bbjlr7PK2HQxBHfTOSyxxGzD%2F%2BQsohXJBM5rxp3mVb%2FAK7V0%2F71ej13eDH27LFFE5Q%3D%3D",weatherApiKey="6b1ef54b6f3279928ef1900844f03f1e",areaCodes={"서울":"1","인천":"2","대전":"3","경기도":"31","강원특별자치도":"32","충청북도":"33","충청남도":"34","경상북도":"35","경상남도":"36","전북특별자치도":"37","전라남도":"38","제주도":"39","대구":"4","광주":"5","부산":"6","울산":"7","세종특별자치시":"8"};app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0}));var storage=multer.diskStorage({destination:function(e,t,r){r(null,"uploads/")},filename:function(e,t,r){r(null,Date.now()+path.extname(t.originalname))}}),upload=multer({storage:storage});app.use(cors()),app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use("/uploads",express.static("uploads")),app.use(express.static(path.join(__dirname,"public"))),app.use("/css",express.static(path.join(__dirname,"public","css"))),app.use("/js",express.static(path.join(__dirname,"public","js"))),app.use(session({secret:"your_secret_key",resave:!1,saveUninitialized:!0}));var db=mysql.createConnection({host:"localhost",user:"root",password:"0517",database:"webserver3"});function fetchAllTouristSpots(e,i){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(function(){var t,R,r,n,o,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:t=serviceKey,R=[],e.t0=regeneratorRuntime.keys(areaCodes);case 3:if((e.t1=e.t0()).done){e.next=14;break}return r=e.t1.value,n=areaCodes[r],o="https://apis.data.go.kr/B551011/KorWithService1/areaBasedList1?MobileOS=ETC&MobileApp=Web&serviceKey=".concat(t,"&numOfRows=1000&pageNo=1&listYN=Y&arrange=O&_type=json&contentTypeId=12&areaCode=").concat(n),e.next=9,regeneratorRuntime.awrap(axios.get(o));case 9:s=e.sent,(a=s.data.response.body.items.item)&&0<a.length?a.forEach(function(e){var t=e.contentid,r=e.contenttypeid,n=e.title,o=e.createdtime,s=e.modifiedtime,a=e.tel,i=e.homepage,c=e.booktour,p=e.firstimage,u=e.firstimage2,d=e.cpyrhtDivCd,l=e.areacode,f=e.sigungucode,m=e.cat1,g=e.cat2,y=e.cat3,b=e.addr1,h=e.addr2,v=e.zipcode,w=e.mapx,x=e.mapy,I=e.mlevel,E=e.overview,j=i?decode(i):"",A=E?decode(E):"";R.push({contentid:t,contenttypeid:r,title:n,createdtime:o,modifiedtime:s,tel:a,homepage:j,booktour:c,firstimage:p,firstimage2:u,cpyrhtDivCd:d,areacode:l,sigungucode:f,cat1:m,cat2:g,cat3:y,addr1:b,addr2:h,zipcode:v,mapx:w,mapy:x,mlevel:I,overview:A})}):console.log("No tourist spots available for the area code ".concat(n,".")),e.next=3;break;case 14:console.log("All tourist spots fetched."),i.json(R);case 16:case"end":return e.stop()}})}());case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),console.error("Error fetching API data:",e.t0.message),i.status(500).send("Error fetching API data.");case 9:case"end":return e.stop()}},null,null,[[0,5]])}db.connect(function(e){if(e)throw e;console.log("MySQL Connected...")}),app.get("/",function(e,t){t.sendFile(path.join(__dirname,"public","index.html"))}),app.get("/area-detail/:id",function(e,t){t.sendFile(path.join(__dirname,"public","area-detail.html"))}),app.get("/details",function(e,t){t.sendFile(path.join(__dirname,"public","details.html"))}),app.get("/details/:id",function(e,t){t.sendFile(path.join(__dirname,"public","details.html"))}),app.get("/tourist-spot/:id",function(e,t){t.sendFile(path.join(__dirname,"public","tourist-spot.html"))}),app.get("/tourist-spot",function(e,t){t.sendFile(path.join(__dirname,"public","tourist-spot.html"))}),app.post("/search-region",function(t,r){var n,o,s,a,i,c,p,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,o=n.region,s=n.pageNo,a=areaCodes[o],i="https://apis.data.go.kr/B551011/KorWithService1/areaBasedList1?MobileOS=ETC&MobileApp=Web&serviceKey=".concat(serviceKey,"&numOfRows=5&pageNo=").concat(s,"&listYN=Y&arrange=O&_type=json&contentTypeId=12&areaCode=").concat(a),console.log("Requesting data from API: ".concat(i)),e.prev=5,e.next=8,regeneratorRuntime.awrap(axios.get(i));case 8:c=e.sent,console.log("API Response: ".concat(JSON.stringify(c.data))),p=c.data.response.body.items.item,u=c.data.response.body.totalCount,r.json({items:p||[],totalCount:u||0}),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(5),console.error("Error fetching data:",e.t0.message),r.status(500).send("Error fetching data.");case 19:case"end":return e.stop()}},null,null,[[5,15]])}),app.post("/barrier-free-info",function(t,r){var n,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.contentId,"K02B7xjfQanY0D0uqbmZ4%2F4wpTBKpZfbm9%2FJ1phXZxRFiDw6dPUGZ4NyeP9MZTiKro6k5aSEjG1InPCB6UNW%2BA%3D%3D",o="https://apis.data.go.kr/B551011/KorWithService1/detailCommon1?MobileOS=ETC&MobileApp=AppTest&contentId=".concat(n,"&defaultYN=Y&overviewYN=Y&addrinfoYN=Y&mapinfoYN=Y&_type=json&serviceKey=").concat("K02B7xjfQanY0D0uqbmZ4%2F4wpTBKpZfbm9%2FJ1phXZxRFiDw6dPUGZ4NyeP9MZTiKro6k5aSEjG1InPCB6UNW%2BA%3D%3D"),console.log("Requesting barrier-free info data from API: ".concat(o)),e.prev=4,e.next=7,regeneratorRuntime.awrap(axios.get(o));case 7:s=e.sent,console.log("Barrier-free info API response:",s.data),r.json(s.data),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(4),console.error("Error fetching barrier-free info data:",e.t0.message),r.status(500).send("Error fetching barrier-free info data");case 16:case"end":return e.stop()}},null,null,[[4,12]])}),app.post("/new-api-endpoint",function(t,r){var n,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.contentId,"K02B7xjfQanY0D0uqbmZ4%2F4wpTBKpZfbm9%252FJ1phXZxRFiDw6dPUGZ4NyeP9MZTiKro6k5aSEjG1InPCB6UNW%252BA%253D%253D",o="https://apis.data.go.kr/B551011/KorWithService1/detailCommon1?MobileOS=WIN&MobileApp=Test&contentId=".concat(n,"&_type=json&serviceKey=").concat(encodeURIComponent("K02B7xjfQanY0D0uqbmZ4%2F4wpTBKpZfbm9%252FJ1phXZxRFiDw6dPUGZ4NyeP9MZTiKro6k5aSEjG1InPCB6UNW%252BA%253D%253D")),e.prev=3,e.next=6,regeneratorRuntime.awrap(axios.get(o));case 6:s=e.sent,r.json(s.data),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(3),console.error("Error fetching new API data:",e.t0),r.status(500).send("Error fetching new API data.");case 14:case"end":return e.stop()}},null,null,[[3,10]])}),app.post("/search-keyword",function(t,r){var n,o,s,a,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.keyword,o=t.body.pageNo||1,s=encodeURIComponent(n),5,a="https://apis.data.go.kr/B551011/KorWithService1/searchKeyword1?MobileOS=ETC&MobileApp=web&keyword=".concat(s,"&_type=json&numOfRows=").concat(5,"&pageNo=").concat(o,"&serviceKey=").concat(serviceKey),console.log("Requesting data from API: ".concat(a)),e.prev=6,e.next=9,regeneratorRuntime.awrap(axios.get(a));case 9:i=e.sent,console.log("API Response: ".concat(JSON.stringify(i.data))),i.data?r.json(i.data):r.status(404).send("No data found"),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(6),console.error("Error fetching data:",e.t0.message),r.status(500).send("Error fetching data");case 18:case"end":return e.stop()}},null,null,[[6,14]])}),app.post("/get-common-info",function(t,r){var n,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.contentId,o="https://apis.data.go.kr/B551011/KorWithService1/detailCommon1?MobileOS=ETC&MobileApp=web&contentId=".concat(n,"&defaultYN=Y&overviewYN=Y&addrinfoYN=Y&mapinfoYN=Y&_type=json&serviceKey=").concat(encodeURIComponent(serviceKey)),e.prev=2,e.next=5,regeneratorRuntime.awrap(axios.get(o));case 5:(s=e.sent).data?r.json(s.data):r.status(404).send("No data found"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),r.status(500).send("Error fetching data");case 12:case"end":return e.stop()}},null,null,[[2,9]])}),app.post("/get-disability-info-and-images",function(t,r){var n,o,s,a,i,c,p,u,d,l,f;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body.contentId,o="https://apis.data.go.kr/B551011/KorWithService1/detailWithTour1?MobileOS=ETC&MobileApp=web&contentId=".concat(n,"&_type=json&serviceKey=").concat(serviceKey),s="https://apis.data.go.kr/B551011/KorWithService1/detailImage1?MobileOS=ETC&MobileApp=web&contentId=".concat(n,"&imageYN=Y&subImageYN=Y&_type=json&serviceKey=").concat(serviceKey),a="https://apis.data.go.kr/B551011/KorWithService1/detailIntro1?MobileOS=ETC&MobileApp=web&contentId=".concat(n,"&contentTypeId=12&_type=json&serviceKey=").concat(serviceKey),i="https://apis.data.go.kr/B551011/KorWithService1/detailCommon1?MobileOS=ETC&MobileApp=web&contentId=".concat(n,"&defaultYN=Y&overviewYN=Y&addrinfoYN=Y&mapinfoYN=Y&_type=json&serviceKey=").concat(serviceKey),e.prev=5,e.next=8,regeneratorRuntime.awrap(Promise.all([axios.get(o),axios.get(s),axios.get(a),axios.get(i)]));case 8:c=e.sent,p=_slicedToArray(c,4),u=p[0],d=p[1],l=p[2],f=p[3],console.log("Disability info API response:",u.data),console.log("Images API response:",d.data),console.log("Intro info API response:",l.data),console.log("Common info API response:",f.data),r.json({disabilityInfo:u.data,images:d.data,introInfo:l.data,commonInfo:f.data}),e.next=25;break;case 21:e.prev=21,e.t0=e.catch(5),console.error("Error fetching data from APIs:",e.t0.message),r.status(500).send("Error fetching data from APIs");case 25:case"end":return e.stop()}},null,null,[[5,21]])}),app.post("/get-weather",function(t,r){var n,o,s,a,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.body,o=n.lat,s=n.lon,a="https://api.openweathermap.org/data/2.5/weather?lat=".concat(o,"&lon=").concat(s,"&appid=").concat(weatherApiKey,"&units=metric&lang=kr"),e.prev=2,e.next=5,regeneratorRuntime.awrap(axios.get(a));case 5:(i=e.sent).data?r.json(i.data):r.status(404).send("No data found"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),r.status(500).send("Error fetching data");case 12:case"end":return e.stop()}},null,null,[[2,9]])}),app.get("/fetch-all-tourist-spots",fetchAllTouristSpots),app.get("/tourist-spot/:id",function(e,t){t.sendFile(path.join(__dirname,"public","tourist-spot.html"))}),app.post("/register",function(e,r){var t=e.body,n=t.name,o=t.email,s=t.password;bcrypt.hash(s,saltRounds,function(e,t){if(e)return r.status(500).json({error:"서버 오류"});db.query("INSERT INTO users (name, email, password) VALUES (?, ?, ?)",[n,o,t],function(e){if(e)return r.status(500).json({error:"회원가입 실패"});r.status(200).json({message:"회원가입 성공"})})})}),app.post("/login",function(n,o){var e=n.body,s=e.email,t=e.password;db.query("SELECT * FROM users WHERE email = ?",[s],function(e,r){return e?(console.error(e),o.status(500).send("로그인 중 오류가 발생했습니다.")):0<r.length?void bcrypt.compare(t,r[0].password,function(e,t){return e?(console.error(e),o.status(500).send("로그인 중 오류가 발생했습니다.")):t?(n.session.loggedin=!0,n.session.userId=r[0].id,n.session.email=s,o.status(200).json({username:r[0].name})):o.status(400).send("아이디 또는 비밀번호가 잘못되었습니다.")}):o.status(400).send("아이디 또는 비밀번호가 잘못되었습니다.")})}),app.delete("/delete-account",function(r,n){if(!r.session.userId)return n.status(401).send("Unauthorized");db.query("DELETE FROM users WHERE id = ?",[r.session.userId],function(e,t){if(e)return n.status(500).send("Database error");r.session.destroy();db.query("SELECT COUNT(*) AS count FROM users",function(e,t){if(e)return n.status(500).send("Failed to check remaining users");if(0===t[0].count){db.query("ALTER TABLE users AUTO_INCREMENT = 1",function(e,t){if(e)return n.status(500).send("Failed to reset AUTO_INCREMENT");n.send("Account deleted and AUTO_INCREMENT reset successfully")})}else n.send("Account deleted successfully")})})}),app.post("/submit-review",upload.single("reviewImage"),function(e,r){var t=e.session.userId,n=e.body.spotId,o=e.body.reviewText,s=e.file?e.file.filename:null;if(!t)return r.status(401).json({success:!1,message:"로그인이 필요합니다."});db.query("INSERT INTO reviews (user_id, spot_id, content, image) VALUES (?, ?, ?, ?)",[t,n,o,s],function(e,t){e?(console.error(e),r.json({success:!1,message:"리뷰 제출 중 오류가 발생했습니다."})):r.json({success:!0})})}),app.get("/reviews",function(e,r){var t=e.query.contentId;db.query("\n      SELECT reviews.*, users.name AS user\n      FROM reviews\n      JOIN users ON reviews.user_id = users.id\n      WHERE reviews.spot_id = ?\n  ",[t],function(e,t){e?(console.error("Error fetching reviews:",e),r.status(500).json({success:!1,message:"리뷰를 가져오는데 실패했습니다."})):r.json({success:!0,reviews:t})})}),app.post("/user-reviews",function(e,r){var t=e.body.userId;db.query("SELECT * FROM reviews WHERE user_id = ?",[t],function(e,t){e?(console.error("Error fetching reviews:",e),r.json({success:!1,message:"Error fetching reviews"})):r.json({success:!0,reviews:t})})}),app.listen(port,function(){console.log("Server running at http://localhost:".concat(port,"/"))});
//# sourceMappingURL=server.min.js.map
